<script>
        let tables = [];

        function requestAdminAccess() {
            const msg = "This area is for TOURNAMENT FACILITATORS ONLY.\n\nPlease do not access unless you are authorized to manage seating.\n\nContinue to Admin Panel?";
            if (confirm(msg)) {
                document.body.classList.add('admin-mode');
                document.getElementById('mode-label').innerText = "ADMIN CONTROL PANEL";
                renderAdmin();
            }
        }

        function exitAdmin() {
            document.body.classList.remove('admin-mode');
            document.getElementById('mode-label').innerText = "Player Check-In Mode";
        }

        function fullShuffle() {
            if(!confirm("Are you sure? This will wipe all current assignments!")) return;
            
            const pCount = parseInt(document.getElementById('playerCount').value);
            const tSize = parseInt(document.getElementById('tableSize').value);
            
            if (isNaN(pCount) || pCount <= 0) return alert("Please enter a valid player count.");

            // 1. Create and Shuffle Player Array
            let players = Array.from({length: pCount}, (_, i) => i + 1);
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }

            // 2. Calculate Balancing Logic
            const numTables = Math.ceil(pCount / tSize);
            const basePlayersPerTable = Math.floor(pCount / numTables);
            const extraPlayers = pCount % numTables; 

            tables = [];
            let currentIndex = 0;

            for (let t = 0; t < numTables; t++) {
                // Each table gets the base count, plus 1 if there are extras left to distribute
                const countForThisTable = basePlayersPerTable + (t < extraPlayers ? 1 : 0);
                
                tables.push({
                    id: t + 1,
                    players: players.slice(currentIndex, currentIndex + countForThisTable).sort((a,b) => a-b),
                    max: tSize
                });
                
                currentIndex += countForThisTable;
            }

            saveAndRender();
        }

        function addLatePlayer() {
            const id = parseInt(document.getElementById('latePlayerId').value);
            const tSize = parseInt(document.getElementById('tableSize').value);
            if(!id) return;
            if(tables.some(t => t.players.includes(id))) return alert("Player already seated!");

            // Find the table with the FEWEST players to keep it balanced
            let target = [...tables].sort((a, b) => a.players.length - b.players.length)[0];
            
            if(target && target.players.length < target.max) {
                target.players.push(id);
                target.players.sort((a,b) => a-b);
            } else {
                // If every existing table is at the user-defined max, start a new one
                tables.push({ id: tables.length + 1, players: [id], max: tSize });
            }
            
            document.getElementById('latePlayerId').value = '';
            saveAndRender();
        }

        function checkSeat() {
            const searchVal = parseInt(document.getElementById('playerSearch').value);
            const resultArea = document.getElementById('resultArea');
            const tableResult = document.getElementById('tableResult');
            const label = document.getElementById('resultLabel');

            if(!searchVal) return;

            const found = tables.find(t => t.players.includes(searchVal));
            resultArea.classList.remove('hidden');
            
            if(found) {
                label.innerText = "Your Assignment";
                label.classList.remove('text-red-500');
                tableResult.innerText = `TABLE ${found.id}`;
                tableResult.classList.remove('text-red-500');
                tableResult.classList.add('text-yellow-500');
            } else {
                label.innerText = "Error";
                label.classList.add('text-red-500');
                tableResult.innerText = "NOT FOUND";
                tableResult.classList.remove('text-yellow-500');
                tableResult.classList.add('text-red-500');
            }
        }

        function resetSearch() {
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('playerSearch').value = '';
        }

        function saveAndRender() {
            localStorage.setItem('poker_data_v5', JSON.stringify(tables));
            renderAdmin();
        }

        // Added this back so you can get the data to GitHub easily
        function exportDataForGitHub() {
            if(tables.length === 0) return alert("Shuffle first!");
            const dataString = JSON.stringify(tables);
            navigator.clipboard.writeText(dataString).then(() => {
                alert("Table data copied to clipboard! Paste this into your GitHub code.");
            });
        }

        function renderAdmin() {
            const container = document.getElementById('tableContainer');
            const stats = document.getElementById('statDisplay');
            container.innerHTML = '';
            
            let totalSeated = 0;
            let totalCapacity = 0;

            tables.forEach(t => {
                totalSeated += t.players.length;
                totalCapacity += t.max;
                
                const card = document.createElement('div');
                card.className = 'table-card bg-slate-900 border border-slate-800 rounded-xl overflow-hidden shadow-lg';
                card.innerHTML = `
                    <div class="bg-slate-800 px-3 py-2 border-b border-slate-700 flex justify-between items-center">
                        <span class="font-black text-xs italic">TABLE ${t.id}</span>
                        <span class="text-[9px] text-slate-500 uppercase">${t.players.length}/${t.max}</span>
                    </div>
                    <div class="p-3 text-xs font-mono text-red-400 leading-relaxed">
                        ${t.players.length > 0 ? t.players.sort((a,b)=>a-b).join(', ') : '<span class="text-slate-700 italic">Empty</span>'}
                    </div>
                `;
                container.appendChild(card);
            });

            stats.innerText = `${totalSeated} / ${totalCapacity}`;
        }

        const saved = localStorage.getItem('poker_data_v5');
        if(saved) {
            tables = JSON.parse(saved);
            renderAdmin();
        }
    </script>
